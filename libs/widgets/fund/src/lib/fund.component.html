<lib-widget [host]="host()">
  @if (canRender()) {
    <div class="toolbar">
      <div>Months:</div>
      <ul class="list">
        @for (timeslot of availableTimeslots; track timeslot.value) {
          <li class="list-item">
            <button
              type="button"
              (click)="selectedTimeslot.set(timeslot.value)"
              [class]="{ active: selectedTimeslot() === timeslot.value }"
            >
              {{ timeslot.label }}
            </button>
          </li>
        }
      </ul>
    </div>
    <div
      echarts
      [options]="chartOption()"
      [autoResize]="true"
      class="chart"
      (chartInit)="onChartInit($event)"
      [theme]="colorSchema()"
    ></div>
  }
  @if (isFullscreen()) {
    <section>
      <div>
        <header>
          <h3>Instruments:</h3>
          <div>
            <lib-typeahead
              placeholder="Search instruments..."
              [formControl]="instrumentSearch"
              [searchFn]="searchInstruments.bind(this)"
              [displayValueFn]="displayValueFn.bind(this)"
              [valueFn]="valueFn.bind(this)"
            >
              <span class="material-symbols-outlined">search</span>
            </lib-typeahead>
          </div>
          @if (showAll()) {
            <button (click)="showAll.set(false)">Watchlist</button>
          } @else {
            <button (click)="showAll.set(true)">Show all</button>
          }

          @if (totalInstruments() > 20) {
            <div class="pager">
              <button type="button" (click)="prevPage()" [disabled]="!hasPrevPage()">
                <span class="material-symbols-outlined">chevron_left</span>
              </button>
              <button type="button" (click)="nextPage()" [disabled]="!hasNextPage()">
                <span class="material-symbols-outlined">chevron_right</span>
              </button>
            </div>
          }
        </header>
        <ul class="list" [class]="showAll() ? 'all' : 'watchlist'">
          @for (instrument of instruments(); track instrument.id) {
            <li
              class="list-item"
              tabindex="0"
              [id]="'instrument_' + instrument.id"
              (click)="showAll() ? addInstrument(instrument) : removeInstrument(instrument)"
              (keypress.delete)="removeInstrument(instrument)"
              (pointerover)="highlightGraph(instrument, $event)"
              (pointerout)="unhighlightGraph(instrument)"
              [class.active]="instrument.id === highlightedInstrument()"
              [class.selected]="showAll() && selectedInstruments().includes(instrument.id)"
              [title]="showAll() ? 'Click to add to watchlist' : 'Click to remove from watchlist'"
            >
              @if (showAll()) {
                <span class="hint material-symbols-outlined">
                  {{ selectedInstruments().includes(instrument.id) ? 'check' : 'add' }}
                </span>
              } @else {
                <span class="hint material-symbols-outlined">remove</span>
              }
              @if (showAll() && selectedInstruments().includes(instrument.id)) {
                <span class="material-symbols-outlined" style="--col: {{ instrument.color }}">check</span>
              } @else {
                <span class="bullet" style="--col: {{ instrument.color }}"></span>
              }
              <span class="content">{{ instrument.id }} - {{ instrument.name }}</span>
            </li>
          } @empty {
            @if (dataLoader.isLoading()) {
              <div class="list-item-empty">Loading...</div>
            } @else if (dataLoader.error()) {
              <div class="list-item-empty">Error: {{ dataLoader.error() }}</div>
            } @else if (showAll()) {
              <div class="list-item-empty">No instruments found.</div>
            } @else {
              <div class="list-item-empty">
                No instruments selected.
                <button (click)="setDefaults()">Set defaults?</button>
              </div>
            }
          }
        </ul>
      </div>
      <footer>
        Data is collected from&nbsp;<a href="https://www.nordnet.se/fonder/lista" target="_blank">nordnet.se</a>
      </footer>
    </section>
  }
</lib-widget>
